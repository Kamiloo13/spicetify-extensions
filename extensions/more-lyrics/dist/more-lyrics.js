(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var i,n,r,l,s,o,e,t,a,d,c,u,p,f,h,g,y,m,v,b,C,w,S,N,E,x,k,F,I,L,T,B,P,D;i=Object.create,n=Object.defineProperty,r=Object.getOwnPropertyDescriptor,l=Object.getOwnPropertyNames,s=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,a=(e=(e,t)=>function(){return t||(0,e[l(e)[0]])((t={exports:{}}).exports,t),t.exports})({"external-global-plugin:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),d=(t=(e,t,a)=>(a=null!=e?i(s(e)):{},((t,a,i,s)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let e of l(a))o.call(t,e)||e===i||n(t,e,{get:()=>a[e],enumerable:!(s=r(a,e))||s.enumerable});return t})(!t&&e&&e.__esModule?a:n(a,"default",{value:e,enumerable:!0}),e)))(e({"external-global-plugin:react"(e,t){t.exports=Spicetify.React}})()),c=t(a()),u=class{constructor(e,t){this.name=e,this.settingsId=t,this.settingsFields={},this.setRerender=null,this.areClassNamesInitialized=!1,this.spotifyClasses={},this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!Spicetify?.Platform?.History?.listen;)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()},this.rerender=()=>{this.setRerender&&this.setRerender(Math.random())},this.getClassByPath=(t,a,i)=>{try{let e=t;for(var s of a){if(!e?.childNodes?.[s])return i;e=e.childNodes[s]}return e.className||i}catch(e){return console.error("[spcr-settings] Error getting class by path:",e),i}},this.initSpotifyClasses=e=>{this.areClassNamesInitialized||(this.spotifyClasses={settingsSection:this.getClassByPath(e,[1],"x-settings-section"),sectionTitle:this.getClassByPath(e,[1,0],"e-91000-text encore-text-body-medium-bold encore-internal-color-text-base"),settingsRow:this.getClassByPath(e,[1,1],"x-settings-row"),firstColumn:this.getClassByPath(e,[1,1,0],"x-settings-firstColumn"),settingLabel:this.getClassByPath(e,[1,1,0,0],"e-91000-text encore-text-body-small encore-internal-color-text-subdued"),secondColumn:this.getClassByPath(e,[1,1,1],"x-settings-secondColumn"),button:this.getClassByPath(e,[8,4,0],"Button-sc-y0gtbx-0 Button-buttonSecondary-small-useBrowserDefaultFocusStyle encore-text-body-small-bold e-9640-button--small x-settings-button"),toggleDivWrapper:this.getClassByPath(e,[3,1,1,0],""),toggleWrapper:this.getClassByPath(e,[3,1,1,0,0],"x-toggle-wrapper"),toggleInput:this.getClassByPath(e,[3,1,1,0,0,0],"x-toggle-input"),toggleIndicatorWrapper:this.getClassByPath(e,[3,1,1,0,0,1],"x-toggle-indicatorWrapper"),toggleIndicator:this.getClassByPath(e,[3,1,1,0,0,1,0],"x-toggle-indicator"),mainDropDown:this.getClassByPath(e,[5,1,1,0,0],"main-dropDown-dropDown"),textInput:"e-91000-form-input e-91000-baseline e-91000-form-control encore-text-body-medium main-topBar-searchBar Mx356zpxhMqMxje_7QXv"},this.areClassNamesInitialized=!0,console.log("[spcr-settings] Initialized Spotify class names:",this.spotifyClasses))},this.render=async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}var e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");this.initSpotifyClasses(e);let t=Array.from(e.children).find(e=>e.id===this.settingsId);t||((t=document.createElement("div")).id=this.settingsId,e.appendChild(t)),c.default.render(d.default.createElement(this.FieldsContainer,null),t)},this.addButton=(e,t,a,i,s)=>{this.settingsFields[e]={type:"button",description:t,value:a,events:{onClick:i,...s}}},this.addInput=(e,t,a,i,s,n)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:a,inputType:s,events:{onChange:i,...n}}},this.addHidden=(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}},this.addToggle=(e,t,a,i,s)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:a,events:{onChange:i,...s}}},this.addDropDown=(e,t,a,i,s,n)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:a[i],options:a,events:{onSelect:s,...n}}},this.getFieldValue=e=>JSON.parse(Spicetify.LocalStorage.get(this.settingsId+"."+e)||"{}")?.value,this.setFieldValue=(e,t)=>{Spicetify.LocalStorage.set(this.settingsId+"."+e,JSON.stringify({value:t}))},this.FieldsContainer=()=>{var[e,t]=(0,d.useState)(0);return this.setRerender=t,d.default.createElement("div",{className:this.spotifyClasses.settingsSection,key:e},d.default.createElement("h2",{className:this.spotifyClasses.sectionTitle},this.name),Object.entries(this.settingsFields).map(([e,t])=>d.default.createElement(this.Field,{nameId:e,field:t})))},this.Field=a=>{var e=this.settingsId+"."+a.nameId;let t;if(t="button"===a.field.type?a.field.value:this.getFieldValue(a.nameId),"hidden"===a.field.type)return d.default.createElement(d.default.Fragment,null);let[i,s]=(0,d.useState)(t),n=e=>{void 0!==e&&(s(e),this.setFieldValue(a.nameId,e))};return d.default.createElement("div",{className:this.spotifyClasses.settingsRow},d.default.createElement("div",{className:this.spotifyClasses.firstColumn},d.default.createElement("label",{className:this.spotifyClasses.settingLabel,htmlFor:e},a.field.description||"")),d.default.createElement("div",{className:this.spotifyClasses.secondColumn},"input"===a.field.type?d.default.createElement("input",{className:this.spotifyClasses.textInput,id:e,dir:"ltr",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,value:i,type:a.field.inputType||"text",placeholder:a.field.defaultValue,...a.field.events,onChange:e=>{n(e.currentTarget.value);var t=a.field.events?.onChange;t&&t(e)}}):"button"===a.field.type?d.default.createElement("span",null,d.default.createElement("button",{id:e,className:this.spotifyClasses.button,"data-encore-id":"buttonSecondary",...a.field.events,onClick:e=>{n();var t=a.field.events?.onClick;t&&t(e)},type:"button"},i)):"toggle"===a.field.type?d.default.createElement("div",{className:this.spotifyClasses.toggleDivWrapper},d.default.createElement("label",{className:this.spotifyClasses.toggleWrapper},d.default.createElement("input",{id:e,className:this.spotifyClasses.toggleInput,type:"checkbox",checked:i,...a.field.events,onClick:e=>{n(e.currentTarget.checked);var t=a.field.events?.onClick;t&&t(e)}}),d.default.createElement("span",{className:this.spotifyClasses.toggleIndicatorWrapper},d.default.createElement("span",{className:this.spotifyClasses.toggleIndicator})))):"dropdown"===a.field.type?d.default.createElement("span",null,d.default.createElement("select",{className:this.spotifyClasses.mainDropDown,id:e,...a.field.events,onChange:e=>{n(a.field.options[e.currentTarget.selectedIndex]);var t=a.field.events?.onChange;t&&t(e)}},a.field.options.map((e,t)=>d.default.createElement("option",{selected:e===i,value:t+1},e)))):d.default.createElement(d.default.Fragment,null)))}}},p=!1,f=e=>{p=e},h=(...e)=>p&&console.log("[More Lyrics]:",...e),g=(...e)=>console.error("[More Lyrics]:",...e),y=window.fetch,m=100,v="more-lyrics.cache-lyrics",b=[],w=C=0,S=e=>JSON.parse(Spicetify.LocalStorage.get("more-lyrics."+e)||"{}")?.value,N=()=>{C>Number.MAX_SAFE_INTEGER-1001&&(C=0),Number.MAX_SAFE_INTEGER-1002<w&&(w=0)},E=async e=>{for(var t=Date.now();w<e;){if(7500<Date.now()-t)throw new Error("Timeout in waitForTurn");await new Promise(e=>setTimeout(e,100))}},x=()=>{Spicetify.LocalStorage.set(v,JSON.stringify(b)),h("Lyrics Data Bank saved to cache")},k=t=>{b.some(e=>e.gid===t.gid)?h(`Lyrics already exist in 'bank' <${t.gid}>`):(b.length>=m&&(b.shift(),h("Lyrics Data Bank overflowed, removing oldest entry")),b.push(t),x())},F=()=>{b.length=0,Spicetify.LocalStorage.remove(v),h("Lyrics Data Bank cleared")},I=()=>{var e=Spicetify.LocalStorage.get(v);if(e)try{b.length=0,b.push(...JSON.parse(e)),h("Lyrics Data Bank loaded from cache")}catch(e){g("Error while parsing cached data. Clearing cache...",e),F()}},L=async(...s)=>{var n=s[0];if("string"==typeof n){if(n.startsWith("https://spclient.wg.spotify.com/color-lyrics/v2/track/")){let i=n.split("/").at(6);if(i){N();try{await E(C++)}catch(e){return g(e),w++,y(...s)}var r=b.find(e=>e.canonical_ids.includes(i));if(r)return w++,r.data?(h(`Lyrics found in 'bank' <${i}>`),new Response(JSON.stringify(r.data),{status:200,statusText:"OK",headers:new Headers({"Content-Type":"application/json"})})):(h(`Lyrics were found in spotify as available <${i}>`),y(...s));w++;let t=Spicetify.Queue.track?.contextTrack;r=t?.uri?.split(":").at(-1);let a=Spicetify.Queue.nextTracks?.[0]?.contextTrack;var l=a?.uri?.split(":").at(-1),o=b.slice(-5).filter(e=>e.metadata);if(r===i){r=o.find(e=>e.metadata?.artist_name===t.metadata.artist_name&&e.metadata?.title===t.metadata.title);if(r)return r.canonical_ids.push(i),x(),h(`Lyrics found in 'bank' after parse <${i}>`),new Response(JSON.stringify(r.data),{status:200,statusText:"OK",headers:new Headers({"Content-Type":"application/json"})})}else if(l===i){r=o.find(e=>e.metadata?.artist_name===a.metadata.artist_name&&e.metadata?.title===a.metadata.title);if(r)return r.canonical_ids.push(i),x(),h(`Lyrics found in 'bank' after parse <${i}>`),new Response(JSON.stringify(r.data),{status:200,statusText:"OK",headers:new Headers({"Content-Type":"application/json"})})}h(`Lyrics not found in 'bank' after parse <${i}>`)}else g("Canonical ID not found in 'color-lyrics' fetch");return y(...s)}if(n.startsWith("https://spclient.wg.spotify.com/metadata/4/track/")){let t=n.split("/").at(6)?.split("?").at(0);if(!t)return g("GID not found in 'metadata' fetch"),y(...s);N();try{await E(C++)}catch(e){return g(e),w++,y(...s)}l=b.find(e=>e.gid===t);if(l)return w++,l.data?(h(`Lyrics found in 'bank' when fetching for 'metadata' <${t}>`),(r=await(o=await y(...s)).clone().json()).has_lyrics=!0,new Response(JSON.stringify(r),{status:o.status,statusText:o.statusText,headers:o.headers})):(h(`Lyrics found in 'bank' but no data when fetching for 'metadata' <${t}>`),y(...s));let e,a;try{e=await y(...s),a=await e.clone().json()}catch(e){return g("Error while fetching metadata",e),w++,y(...s)}n=a.canonical_uri.split(":").at(-1);if(a.has_lyrics)return h(`Lyrics found in 'metadata' <${t}>`),k({gid:t,canonical_ids:[n]}),w++,e;l=S("api-token"),r=await y(`${S("api-endpoint")??"https://lyrics.kamiloo13.me/api"}/get?artist=${a.artist[0].name}&track=${a.name}&duration=${Math.round(a.duration/1e3)}&album=${a.album.name}&username=`+Spicetify.Platform.username,l?{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+l}}:void 0).catch(()=>null),o=await r?.json().catch(()=>null);if(w++,!o||!r?.ok)return h(`Lyrics NOT found in 'lyrics.kamiloo13.me' <${t}>`),k({gid:t,canonical_ids:[n]}),e;h(`Lyrics found in 'lyrics.kamiloo13.me' <${t}>`);l={colors:{background:-10848593,highlightText:-1,text:-16777216},hasVocalRemoval:!1,lyrics:{alternatives:[],capStatus:"NONE",isDenseTypeface:!1,isRtlLanguage:!1,language:a.language_of_performance[0],lines:o.lines,previewLines:o.lines.slice(0,5),provider:o.provider,providerDisplayName:o.providerLyricsDisplayName+" (more-lyrics)",providerLyricsId:o.providerLyricsId,syncLyricsUri:"",syncType:o.isSynced?"LINE_SYNCED":"UNSYNCED"}};return k({gid:t,canonical_ids:[n],data:l,metadata:{artist_name:a.artist[0].name,title:a.name}}),a.has_lyrics=!0,new Response(JSON.stringify(a),{status:e.status,statusText:e.statusText,headers:e.headers})}}return y(...s)},T=e=>{window.fetch=e?L:y,h("Fetch override is now "+(e?"enabled":"disabled")),h(`Lyrics Data Bank had ${b.length} entries`,b),e?(I(),w=C=0,h("Request count: "+C),h("Current request ID: "+w)):(b.length=0,h("Request count: "+C),h("Current request ID: "+w),C=Number.MAX_SAFE_INTEGER-1e3,w=Number.MAX_SAFE_INTEGER-1e3),h(`Lyrics Data Bank has now ${b.length} entries`,b)},B="https://lyrics.kamiloo13.me/api",P=/^https?:\/\/([\w-]+(\.[\w-]+)+|localhost)(:[0-9]{1,5})?(\/[^\s\?]*)?$/,D=async function(){let a=new u("More Lyrics","more-lyrics");var e=a.getFieldValue("api-endpoint");P.test(e)?a.setFieldValue("api-input-endpoint",e):(a.setFieldValue("api-endpoint",B),a.setFieldValue("api-input-endpoint",B)),a.addToggle("app-enabled","Enable More Lyrics (overrides Spotify's fetch function)",!0,()=>{var e=Boolean(a.getFieldValue("app-enabled"));T(e)}),a.addInput("api-input-endpoint",`API Endpoint (default: ${B})`,B,()=>{},"text",{onBlur:e=>{var t=e.target.value;4<t.length&&t===a.getFieldValue("api-endpoint")||(P.test(t)?(a.setFieldValue("api-endpoint",t),Spicetify.showNotification("API Endpoint saved!")):(e.target.value=B,a.setFieldValue("api-endpoint",B),a.setFieldValue("api-input-endpoint",t),Spicetify.showNotification("Invalid API Endpoint. Default value restored.")))}}),a.addHidden("api-token",""),a.addInput("api-token-input","API Token (optional)","",()=>{},"text",{onBlur:e=>{e=e.target.value;e!==a.getFieldValue("api-token")&&(a.setFieldValue("api-token",e),Spicetify.showNotification("API Token saved!"))}}),a.addToggle("enable-debug","Enable debug logging",!1,()=>{f(Boolean(a.getFieldValue("enable-debug")))}),a.addButton("clear-cache","Clear Lyrics Cache","Clear",()=>{F(),Spicetify.showNotification("Lyrics cache cleared!")}),a.pushSettings(),"1"!==(e=a.getFieldValue("cache-version"))&&(a.setFieldValue("cache-version","1"),F()),f(Boolean(a.getFieldValue("enable-debug"))),T(Boolean(a.getFieldValue("app-enabled")))},(async()=>{await D()})()})();